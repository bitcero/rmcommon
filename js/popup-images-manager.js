function send_resize(e,i){$.get(url,{data:i,img:e,action:"resize"},function(e){if(e.error)return $("#resizer-bar span.message").html("<span>"+e.message+"</span>"),void resize_image(i);var t='<img src="'+e.file+'" alt="" title="'+e.title+'" />';$("#gen-thumbnails").append(t),$("#resizer-bar span.message").html(e.message+" - "+current+" of "+total),resize_image(i)},"json")}function resize_image(e){if(!(ids.length<=0)){if(void 0==ids[current])return $("#bar-indicator").html("100%"),$("#bar-indicator").animate({width:"100%"},100),current=0,total=0,ids=new Array,void show_library();percent=1/total*100,send_resize(ids[current],e),$("#bar-indicator").animate({width:percent*current+"%"},100),$("#bar-indicator").html(Math.round(percent*current+1)+"%"),current++}}function show_upload(){$("#resizer-bar").hide("slow"),$(".categories_selector").show("slow"),$("#upload-errors").show("slow"),$("#upload-controls").slideDown("slow"),$("#bar-indicator").html(""),$("#bar-indicator").css("width","0px"),$("#gen-thumbnails").hide("slow",function(){$("#gen-thumbnails").html("")})}function show_library(e){if($("#ret-token").length>0&&$("#xoops-token").val($("#ret-token").val()),2==$("#category-field option").length){$("#category-field option").removeAttr("selected");var i=$("#category-field option");$(i[1]).attr("selected","selected")}var t={category:$("#category-field").val(),action:"load-images",XOOPS_TOKEN_REQUEST:$("#xoops-token").val(),url:window.parent.location.href,page:e,type:$("#type").val(),editor:$("#editor").val(),name:$("#name").val(),target:$("#target").val(),multi:$("#multi").val(),idcontainer:$("#idcontainer").val(),custom:$("#parameters input").serialize()};$("#library-content").html(""),$("#library-content").addClass("loading"),$.post("tiny-images.php",t,function(e,i){$("#library-content").html(e),$("#library-content").removeClass("loading"),$(".sizes input[type='radio']").click(function(){var e=$(this).val(),i=$(this).attr("name").replace("size_","");$("#data-"+i+" .size_url").html("<span>"+e+"</span>")})},"html")}function populate_inserter_data(e,i){$("#image-inserter > .content .image").css("background-image","url('"+i.medium+"')"),$("#image-inserter > .content .img-id").val(e),$("#image-inserter .author-info .author-avatar").attr("src",i.author.avatar),$("#image-inserter .author-info a").attr("href",i.author.url),$("#image-inserter .author-info .media-heading a").html(i.author.uname),$("#image-inserter .author-info .info-date").html(i.date),$("#image-inserter .image-info .info-title").html(i.title),$("#image-inserter .image-info .info-description").html(i.description),$("#image-inserter .image-info .info-mime").html(i.mime),$("#image-inserter .image-info .info-original").html('<a href="'+i.original.url+'" target="_blank">'+i.original.file+"</a>"),$("#image-inserter .image-info .info-size").html(i.original.size),$("#image-inserter .image-info .info-dimensions").html(i.original.width+" x "+i.original.height),$("#image-inserter > .content .img-title").val(i.title),$("#image-inserter > .content .img-description").val(i.description),$("#image-inserter > .content .img-link").val(i.original.url),$("#image-inserter > .content .img-links").html("");for(var t in i.links)$("#image-inserter > .content .img-links").append('<button type="button" class="btn btn-default" data-link="'+i.links[t].value+'">'+i.links[t].caption+"</button>");$("#image-inserter > .content .img-sizes").html("");for(var t in i.sizes)$("#image-inserter > .content .img-sizes").append('<label><input class="img-size" data-width="'+i.sizes[t].width+'" data-name="'+i.sizes[t].name+'" data-height="'+i.sizes[t].height+'" type="radio" name="size" value="'+i.sizes[t].url+'"><span><strong>'+i.sizes[t].name+"</strong><br><small>("+i.sizes[t].width+" x "+i.sizes[t].height+")</small></span></label>");$("#image-inserter > .content .img-sizes label:last-child input").prop("checked","checked"),void 0!=i.token&&$("#ret-token").val(i.token)}function show_image_inserter(e){e=void 0==e||"insert"==e?"insert":"edit",$("#inserter-blocker").fadeIn(250).click(function(){$("#image-inserter").fadeOut(250,function(){$("#inserter-blocker").fadeOut(250),$("body").css("overflow","auto")})}),$("#image-inserter").fadeIn(250),$("body").css("overflow","hidden"),"edit"==e?($("#image-inserter .btn-insert").hide(),$("#image-inserter .btn-edit").show(),$("#image-inserter .btn-edit-next").show()):($("#image-inserter .btn-edit").hide(),$("#image-inserter .btn-edit-next").hide(),$("#image-inserter .btn-insert").show())}function hide_image_inserter(){$("#image-inserter").fadeOut(250,function(){$("#inserter-blocker").fadeOut(250),$("body").css("overflow","auto")})}function show_image_data(e){$("#ret-token").length>0&&$("#xoops-token").val($("#ret-token").val());var i={category:$("#category-field").val(),action:"image-details",XOOPS_TOKEN_REQUEST:$("#xoops-token").val(),id:e,url:window.parent.location.href};return $.post("tiny-images.php",i,function(i){return void 0!=i.error?(alert(void 0!=i.message?i.message:"An error ocurred"),src.find(".add").removeClass("hidden").fadeIn(250),remove_from_tray(e),!1):(populate_inserter_data(e,i),void show_image_inserter("insert"))}),!1}function hide_image_data(e){$(".image_list").show(),$(".image_data").hide()}function insert_image(e,i){if(void 0==e)return!1;i=void 0==i||"no"==i?!1:!0;var t=e.id,a=$("#type").val(),n=$("#target").val(),r=$("#idcontainer").val();if("exmcode"==a){var o="",l=$("#extension_"+t).val();""!=e.link&&(c="[url="+e.link+"]"),c+="[img",c+=""!=e.align?" align="+e.align:"",c+="]";var s=e.size;return c+=s,c+="[/img]",e.link&&(c+="[/url]"),c}if("markdown"==a){var d=$("#md-as input:checked");if("md"==d.val()){var m="";return e.link&&(m+="["),m+="!["+e.title+"]("+e.size+")",e.link&&(m+="]("+e.link+") "),m}var c="";return""!=e.link&&(c='<a href="'+e.link+'" title="'+e.title+'">'),c+='<img src="'+e.size+'"',c+=""!=e.align?' class="'+e.align+'"':"",c+=""!=e.alt?' alt="'+e.alt+'"':"",c+=">",""!=e.link&&(c+="</a>"),c}if("external"==a){var g={link:e.link,url:e.size,title:e.title,alt:e.alt,description:e.description,align:e.align,thumbnail:e.thumbnail,id:t};return g}var c="";if(""!=e.link&&(c='<a href="'+e.link+'" title="'+e.title+'">'),c+='<img src="'+e.size+'"',c+=""!=e.align?' class="'+e.align+'"':"",c+=""!=e.alt?' alt="'+e.alt+'"':"",c+=">",""!=e.link&&(c+="</a>"),void 0!=n&&"container"==n){var u=window.parent.$("#"+r+"-container").data("accept");return i?'<div style="margin-bottom: 10px; text-align: center;"><a href="'+e.size+'" target="_blank"><img src="'+("thumbnail"==u?e.thumbnail:e.size)+'"></a><input type="hidden" name="'+r+'[]" id="'+r+'" value="'+t+":"+e.name+":"+encodeURIComponent(e.link)+":"+encodeURIComponent(e.title)+'"><a href="#" class="btn btn-warning btn-xs" onclick="$(this).parent().remove(); return false;">Remove Image</a></div>':'<a href="'+e.size+'" target="_blank"><img src="'+("thumbnail"==u?e.thumbnail:e.size)+'" /></a><input type="hidden" name="'+r+'" id="'+r+'" value="'+t+":"+e.name+":"+encodeURIComponent(e.link)+":"+encodeURIComponent(e.title)+'" /><br /><a href="#" class="removeButton removeButton-'+r+'">Remove Image</a>'}return c}function send_to_element(data){var id=data.id,type=$("#type").val(),target=$("#target").val(),container=$("#idcontainer").val();"exmcode"==type?(exmPopup.insertText(data),exmPopup.closePopup()):"html"==type?window.parent.edInsertContent(container,data):"markdown"==type?window.parent.mdEditor.insert(container,data):"external"==type?eval("window.parent."+target+"(data, container)"):"simple"==type?insert_at_cursor(window.parent.$("#"+container),data):void 0!=target&&"container"==target?"yes"==$("#multi").val()?window.parent.$("#"+container+"-container .thumbnail").append(data):window.parent.$("#"+container+"-container .thumbnail").html(data):null!=tinyMCEPopup.editor?(ed=tinyMCEPopup.editor,ed.execCommand("mceInsertContent",!0,data),tinyMCEPopup.close()):ed=tinyMCE.get($("#idcontainer").val())}function insert_from_url(e){if(""==$("#imgurl").val())return void $("#imgurl").focus();if("xoops"==e){var t="";""!=$("#url-link").val()&&(t+="[url="+$("#url-link").val()+"]"),t+="[img";var a=$("input[name='align_url']");for(i=0;i<a.length;i++)$(a[i]).attr("checked")&&""!=$(a[i]).val()&&(t+=" align="+$(a[i]).val());return t+="]"+$("#imgurl").val()+"[/img]",""!=$("#url-link").val()&&(t+="[/url]"),exmPopup.insertText(t),void exmPopup.closePopup()}ed=tinyMCEPopup.editor;var n="";""!=$("#url-link").val()&&(n='<a href="'+$("#url-link").val()+'" title="'+$("#url-title").val()+'">'),n+='<img src="'+$("#imgurl").val()+'" alt="'+$("#url-alt").val()+'"';var a=$("input[name='align_url']");for(i=0;i<a.length;i++)$(a[i]).attr("checked")&&""!=$(a[i]).val()&&(n+=' class="'+$(a[i]).val()+'"');n+=" />",""!=$("#url-link").val()&&(n+="</a>"),ed.execCommand("mceInsertContent",!0,n),tinyMCEPopup.close()}function add_image_tray(e){if(void 0==e||0>=e)return alert("No image to add"),!1;var i=$("#thumbnail-"+e);if(i.length<=0)return!1;$("#inserter-blocker").fadeIn(250);var t=$('<span class="img">'),a=i.css("background-image");t.css("background-image","url(../images/wait.gif)"),t.css("background-size","16px 16px"),t.attr("data-id",e),$("#images-tray > .tray-added > .images").append(t),t.fadeIn(350),i.find(".add").fadeOut(250).addClass("hidden"),$("#ret-token").length>0&&$("#xoops-token").val($("#ret-token").val());var n={category:$("#category-field").val(),action:"image-details",XOOPS_TOKEN_REQUEST:$("#xoops-token").val(),id:e,url:window.parent.location.href};return $.post("tiny-images.php",n,function(n){return void 0!=n.error?(alert(void 0!=n.message?n.message:"An error ocurred"),i.find(".add").removeClass("hidden").fadeIn(250),remove_from_tray(e),!1):(selected[e]=n,void 0!=n.token&&$("#ret-token").val(n.token),i.addClass("thumb-selected"),t.css("background-size","36px 36px"),t.css("background-image",a),$("#inserter-blocker").fadeOut(250),populate_inserter_data(e,n),void show_image_inserter("edit"))}),$("#images-tray").fadeIn("fast",function(){$("body").animate({paddingBottom:100})}),!1}function remove_from_tray(e){if(void 0==e||0>=e)return!1;var i=$("#images-tray .img[data-id='"+e+"']");return i.length<=0?!1:void $(i).fadeOut(250,function(){$(i).remove(),$("#thumbnail-"+e).removeClass("thumb-selected"),$("#thumbnail-"+e+" .add").removeClass("hidden").fadeIn(250),delete selected[e],$("#images-tray .img").length<=0&&$("#images-tray").fadeOut(250,function(){$("body").animate({paddingBottom:10})})})}function edit_image_ontray(e){if(void 0!=selected[e]){var i=selected[e];populate_inserter_data(e,i),show_image_inserter("edit")}}function set_image_data(e){e=void 0==e||"no"==e?!1:!0;var i=$("#image-inserter .img-id").val(),t={id:i,type:$("#type").val(),func:$("#target").val(),container:$("#idcontainer").val()},a=read_inserter_data(t.id);selected[i].title=a.title,selected[i].alt=a.alt,selected[i].description=a.description,selected[i].link=a.link,selected[i].align=a.align,selected[i].size=a.size,selected[i].thumbnail=a.thumbnail,e||hide_image_inserter()}function read_inserter_data(e){if(!$("#image-inserter").is(":visible"))return!1;if($("#image-inserter .img-id").val()!=e)return!1;var i={id:$("#image-inserter .img-id").val(),title:$("#image-inserter .img-title").val(),alt:$("#image-inserter .img-alt").val(),description:$("#image-inserter .img-description").val(),link:$("#image-inserter .img-link").val(),align:$("#image-inserter .img-align:checked").val(),size:$("#image-inserter .img-size:checked").val(),name:$("#image-inserter .img-size:checked").data("name")},t=0;return $("#image-inserter .img-size").each(function(e){(0==e||$(this).data("width")<t)&&(i.thumbnail=$(this).val())}),i}function insert_multiple_images(){var e="",i=[],t;for(var a in selected)void 0!=selected[a]&&(t=insert_image(selected[a],"yes"),null!==t&&"object"==typeof t?i[i.length]=t:e+=t);send_to_element(i.length>0?i:e)}function insert_at_cursor(e,i){if(document.selection)e.focus(),sel=document.selection.createRange(),sel.text=i;else if($(e)[0].selectionStart||"0"==$(e)[0].selectionStart){var t=$(e)[0].selectionStart,a=$(e)[0].selectionEnd;$(e).val($(e).val().substring(0,t)+i+$(e).val().substring(a,$(e).val().length))}else $(e).val(i)}var total=0,ids=new Array,url="",current=0,selected=new Array;$(document).ready(function(){$("div.container").hide(),$("#upload-container").show(),$("#img-toolbar a").click(function(){$("div.container").hide(),$("#img-toolbar a").removeClass("select"),$(this).addClass("select"),id=$(this).attr("id").replace("a-",""),$("#"+id+"-container").show()}),$("body").on("click",".thumbnail-item > .insert",function(){return show_image_data($(this).parent().data("id")),!1}),$("body").on("click",".thumbnail-item > .add",function(){return add_image_tray($(this).parent().data("id")),!1}),$("body").on("mouseover",".thumbnail-item",function(){$("#images-tray .img[data-id='"+$(this).data("id")+"']").addClass("mini-hover")}),$("body").on("mouseout",".thumbnail-item",function(){$("#images-tray .img[data-id='"+$(this).data("id")+"']").removeClass("mini-hover")}),$("body").on("mouseover","#images-tray .tray-added .img",function(){$(".thumbnail-item[data-id='"+$(this).data("id")+"']").addClass("thumbnail-hover")}),$("body").on("mouseout","#images-tray .tray-added .img",function(){$(".thumbnail-item[data-id='"+$(this).data("id")+"']").removeClass("thumbnail-hover")}),$("body").on("click",".thumbnail-item.thumb-selected",function(){remove_from_tray($(this).data("id"))}),$("body").on("click","#image-inserter > .content .img-links button",function(){$("#image-inserter > .content .img-link").val($(this).data("link"))}),$("body").on("click","#image-inserter .btn-close",function(){$("#inserter-blocker").click()}),$("body").on("click","#images-tray .btn-clear",function(){$("#images-tray .tray-added .img").fadeOut(250,function(){$(this).remove(),$(".thumb-selected").removeClass("thumb-selected").find(".add").removeClass("hidden").fadeIn(250),selected=new Array,$("#images-tray").fadeOut(250,function(){$("body").animate({paddingBottom:10})})})}),$("body").on("click","#image-inserter .btn-insert",function(){send_to_element(insert_image(read_inserter_data($("#image-inserter .img-id").val()))),window.parent.$("#blocker-"+$("#idcontainer").val()).click()}),$("body").on("click",".tray-commands .btn-insert",function(){insert_multiple_images(),window.parent.$("#blocker-"+$("#idcontainer").val()).click()}),$("body").on("click","#image-inserter .btn-edit",function(){set_image_data("no")}),$("body").on("click",".tray-added .img",function(){edit_image_ontray($(this).data("id"))})});
