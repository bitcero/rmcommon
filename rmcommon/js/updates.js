function rmCheckUpdates(){$.get(xoUrl+"/modules/rmcommon/ajax/updates.php",{XOOPS_TOKEN_REQUEST:$("#cu-token").val()},function(e){if(""!=e.token&&$("#cu-token").val(e.token),e.total<=0)return!1;rmCallNotifier(e.total)},"json")}function rmCallNotifier(e){if(!(e<=0)){if("function"==typeof updatesNotifier&&updatesNotifier(e),$("#updater-info").length<=0)return!1;$("#updater-info").html($("#updater-info").html().replace("%s",e)),$("#updater-info").fadeIn("fast")}}function downloadUpdate(id){if(null==id||void 0==id)return!1;var updates=eval($("#json-container").html()),update=updates[id].data;if(null==update.url.match(/^http:\/\//))return!1;var url=update.url.replace(/\&amp;/,"&");if(1==update.login&&void 0==credentials[id])return $("#upd-login .ok-login").attr("data-id",id),$("#upd-login").data("next","download"),void showLogin(update);var params={action:"later",url:url,credentials:void 0==credentials[id]?"":credentials[id],type:update.type,dir:update.dir};$.post("updates.php",params,function(e){if(1==e.error)return alert(e.message),void(""!=e.token&&$("#cu-token").val(e.token));""!=e.token&&$("#cu-token").val(e.token),$("#upd-"+id+" .button-later > i").removeClass("icon-spinner icon-spin").addClass("icon-time"),window.location.href="updates.php?action=getfile&file="+e.data.file},"json")}function installLater(id){if(null==id||void 0==id)return!1;$("#upd-"+id+" .button-later > i").removeClass("icon-time").addClass("icon-spinner icon-spin");var updates=eval($("#json-container").html()),update=updates[id].data;if(null==update.url.match(/^http:\/\//))return!1;var url=update.url.replace(/\&amp;/,"&")+"&action=download";if(1==update.login&&void 0==credentials[id])return $("#upd-login .ok-login").attr("data-id",id),$("#upd-login").data("next","download"),void showLogin(update);downloadUpdate(id)}function showWarning(e){$("#upd-info-blocker").fadeIn("fast"),$("#upd-warning h4").html(e.title),$("#upd-warning p").html(e.warning),$("#upd-warning").fadeIn("fast")}function updateStepOne(e,t){var a={action:"first-step",url:e.url.replace(/\&amp;/,"&"),credentials:void 0==credentials[t]?"":credentials[t],type:e.type,dir:e.dir,ftp:$("#ftp-form").serialize(),XOOPS_TOKEN_REQUEST:$("#cu-token").val()};incrementProgress("50%",t),$.post("updates.php",a,function(a){if(1==a.error)return $("#upd-"+t+" .upd-progress .status").html(a.message),$("#upd-"+t+" .progress-bar").addClass("progress-bar-danger"),$("#upd-"+t+" .progress").removeClass("active"),""!=a.token&&$("#cu-token").val(a.token),!1;""!=a.token&&$("#cu-token").val(a.token),$("#upd-"+t+" .upd-progress .status").html(a.message),"module"==e.type||"plugin"==e.type?(incrementProgress("80%",t),local_update(t)):(incrementProgress("100%",t),$("#upd-"+t+" .progress-bar").addClass("progress-bar-success"),$("#upd-"+t+" .progress").removeClass("active"),$("#upd-"+t+" h4").addClass("update-done"))},"json")}function local_update(id){var updates=eval($("#json-container").html()),update=updates[id].data,params={action:"local-update",type:update.type,module:update.dir,XOOPS_TOKEN_REQUEST:$("#cu-token").val()};$.post("updates.php",params,function(e){if(1==e.error)return $("#upd-"+id+" .upd-progress .status").html(e.message),$("#upd-"+id+" .progress-bar").addClass("progress-bar-danger"),$("#upd-"+id+" .progress").removeClass("active"),""!=e.token&&$("#cu-token").val(e.token),!1;""!=e.token&&$("#cu-token").val(e.token),cuHandler.modal.dialog({message:e.data.log,title:"Module update log",width:"large"}),$("#upd-"+id+" .upd-progress .status").html(e.message),incrementProgress("100%",id),$("#upd-"+id+" .progress-bar").addClass("progress-bar-success"),$("#upd-"+id+" .progress").removeClass("active"),$("#upd-"+id+" h4").addClass("update-done")},"json")}function runFiles(id,run){var files=eval(run),total=files.length-1,start=0;$("#files-blocker").fadeIn("fast",function(){$("#upd-run").fadeIn("fast",function(){$("#upd-run > iframe").attr("src",files[start]).load(function(){start<total?(start++,$(this).attr("src",files[start])):$("#upd-run").fadeOut("fast",function(){$("#files-blocker").fadeOut("fast",function(){$("#upd-"+id+" .upd-progress .status").html(langUpdated),incrementProgress("100%",id),$("#upd-"+id+" .progress").addClass("progress-bar-success").removeClass("active"),$("#upd-"+id+" h4").addClass("update-done")})})})})})}function incrementProgress(e,t){$("#upd-"+t+" .progress > .progress-bar").width(e)}var warns=new Array,credentials=new Array;!function(e){this.UpdatesController=function(){var t=this;this.progress=[],this.init=function(){this.loadUpdates(),e("#upds-ftp, #ftp-settings .btn-primary").click(function(){t.ftpSettings()}),e("#upd-warning .cancel-warning").click(function(){t.hideWarning(e(this).data("id"))}),e("#refresh-updates").click(function(){e(this).children("span").addClass("fa-spin"),e(".rm-loading").fadeIn("fast"),e("#rmc-updates > div").each(function(){e(this).fadeOut("fast",function(){e(this).remove()})}),e.get(xoUrl+"/modules/rmcommon/ajax/updates.php",{XOOPS_TOKEN_REQUEST:e("#cu-token").val()},function(){t.loadUpdates(),e("#refresh-updates > span").removeClass("fa-spin")},"json")}),e("#upd-login .cancel-login, #upd-login .close").click(function(){var a=e("#upd-login .cancel-login").data("id");e(".btn-install[data-id='"+a+"']").cuSpinner(),t.hideProgress(a),t.hideLogin(a)}),e("body").on("click",".btn-install",function(){t.installUpdate(e(this).data("id"),!0)}),e("body").on("click",".button-details",function(){var a=e(this).data("id");e(this).cuSpinner({icon:"svg-rmcommon-spinner-03"}),t.loadUpdateDetails(a,e(this))}),e("#upd-warning .continue-update").click(function(){e("#upd-warning .cancel-warning").click();var a=e(this).attr("data-id");void 0==a||a<0||(warns[a]=1,t.installUpdate(a))}),e("#upd-login .ok-login").click(function(){t.sendLogin()})},this.updateStatus=function(t,a,s,r){e("#upd-"+t+" .upd-progress .status").html(a),void 0!=s&&(e("#upd-"+t+" .progress-bar").addClass("progress-bar-"+s),e("#upd-"+t+" > .upd-progress > .status").attr("class","").addClass("status text-"+s)),void 0!=r&&1==r&&(e("#upd-"+t+" .progress .progress-bar").removeClass("active"),e("#upd-"+t+" > .upd-progress > .progress").removeClass("active"))},this.hideWarning=function(t){e(".btn-install[data-id='"+t+"']").cuSpinner(),e("#upd-warning").fadeOut("fast",function(){e("#upd-info-blocker").fadeOut("fast")})},this.ftpSettings=function(){e("#ftp-settings").slideToggle("fast"),e("#upds-ftp").hasClass("active")?e("#upds-ftp").removeClass("active"):e("#upds-ftp").addClass("active")},this.loadUpdates=function(){e.get("updates.php",{action:"ajax-updates"},function(t){void 0!=t.token&&e("#cu-token").val(t.token),e("#rmc-updates").append(t),e(".rm-loading").fadeOut("fast"),e("#rmc-updates > .upd-item").each(function(){e(this).fadeIn("fast")})},"html")},this.loadUpdateDetails=function(t,a){if(null==t||void 0==t)return!1;var s=JSON.parse(e("#json-container").html())[t].data;if(s.id=t,""==s.url)return!1;if(null==s.url.match(/^http:\/\/|^https:\/\//))return!1;var r=s.url.replace(/\&amp;/,"&");e.get("updates.php",{action:"update-details",url:r},function(t){if(e(a).cuSpinner(),0==cuHandler.retrieveAjax(t))return!1},"json")},this.installUpdate=function(a,s){if(void 0==a)return!1;var r=JSON.parse(e("#json-container").html())[a].data;if(r.id=a,null==r.url.match(/^http:\/\/|https:\/\//))return!1;e(".btn-install[data-id='"+a+"']").cuSpinner({icon:"svg-rmcommon-spinner-02",class:"text-warning"});r.url.replace(/\&amp;/,"&");if(""!=r.warning&&void 0==warns[a])return e("#upd-warning .continue-update").attr("data-id",a),e("#upd-warning .cancel-warning").attr("data-id",a),void showWarning(r);t.showProgress(a,s),void 0!=r.login&&r.login>0&&void 0==credentials[r.id]?t.showLogin(r):(t.updateStatus(a,cuLanguage.waitingResponse),t.queryToServer(r,{remote:"getfile",api:r.api,credentials:credentials[a],serial:r.serial,ftp:btoa(e("#ftp-form").serialize())}))},this.queryToServer=function(a,s){s.url=a.url,s.action="process",e.post("updates.php",s,function(s){if(0==cuHandler.retrieveAjax(s))return t.progressBarError(a.id),t.updateStatus(a.id,s.message,"danger",!0),credentials[a.id]=void 0,clearTimeout(t.progress[a.id]),!1;switch(s.response){case"installed":credentials[a.id]=void 0,e(".btn-install[data-id='"+a.id+"']").cuSpinner().fadeOut("fast"),e(".btn-later[data-id='"+a.id+"']").fadeOut("fast"),t.updateStatus(a.id,cuLanguage.installed,"green",!0),t.updateProgressBar(a.id,100);break;case"login":t.showLogin(a)}},"json")},this.showProgress=function(a,s){e("#upd-"+a+" > .upd-progress .progress-bar").removeClass("progress-bar-danger").addClass("active"),e("#upd-"+a+" > .upd-progress .status").attr("class","").addClass("text-info status"),void 0!=s&&e("#upd-"+a+" > .upd-progress .progress-bar").css("width","0px"),e("#upd-"+a).addClass("upd-item-process"),e("#upd-"+a+" .upd-progress").slideDown("fast"),t.updateProgressBar(a)},this.hideProgress=function(a){e("#upd-"+a).removeClass("upd-item-process"),e("#upd-"+a+" .upd-progress").slideUp("fast"),clearTimeout(t.progress[a])},this.updateProgressBar=function(a,s){var r=e("#upd-"+a+" > .upd-progress > .progress > .progress-bar").width()/e("#upd-"+a+" .upd-progress .progress").width();if(!e("#upd-"+a+" > .upd-progress > .progress > .progress-bar").hasClass("progress-bar-danger"))return void 0!=s?(e("#upd-"+a+" .upd-progress .progress-bar").css("width",s+"%"),void e("#upd-"+a+" .upd-progress .progress-bar").addClass("probress-bar-success")):void(r>=1||(width=r+.01>1?100:100*(r+.01),e("#upd-"+a+" .upd-progress .progress-bar").css("width",width+"%"),t.progress[a]=setTimeout(function(){t.updateProgressBar(a)},1e3)))},this.progressBarError=function(a){clearTimeout(t.progress[a]);var s=e("#upd-"+a+" > .upd-progress > .progress");e(s).removeClass("active").find("> .progress-bar").addClass("progress-bar-danger")},this.sendLogin=function(){if(""!=e("#uname").val())if(""!=e("#upass").val()){var a=e("#upd-login .ok-login").data("id");t.updateStatus(a,cuLanguage.loginVerify),setTimeout(function(){t.updateProgressBar(a)},1e3),t.hideLogin(a),void 0==a||a<0||(JSON.parse(e("#json-container").html())[a].data.id=a,credentials[a]=btoa(e("#uname").val()+":"+e("#upass").val()),e("#uname").val(""),e("#upass").val(""),t.updateStatus(a,cuLanguage.requestFile),t.installUpdate(a))}else e("#upass").addClass("error").focus();else e("#uname").addClass("error").focus()},t.hideLogin=function(){e("#upd-login").fadeOut("fast",function(){e("#login-blocker").fadeOut("fast"),e("#upd-login input").val("")})},this.showLogin=function(a){clearTimeout(t.progress[a.id]),t.updateStatus(a.id,cuLanguage.loginRequired),e("#upd-login .ok-login").data("id",a.id),e("#upd-login .cancel-login").data("id",a.id),e("#login-blocker").fadeIn("fast",function(){var t=document.createElement("a");t.href=a.url,e("#upd-login").fadeIn("fast",function(){e("#uname").focus()}),e("#upd-login p").html(e("#upd-login p").html().replace("%site%",'<a href="http://'+t.hostname+'" target="_blank">'+t.hostname+"</a>"))})},this.sendApi=function(){}}}(jQuery);var updates;$(document).ready(function(){(updates=new UpdatesController).init()});