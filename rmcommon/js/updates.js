function loadUpdates(){$.get("updates.php",{action:"ajax-updates"},function(a){void 0!=a.token&&$("#cu-token").val(a.token),$("#rmc-updates").append(a),$(".rm-loading").fadeOut("fast"),$("#rmc-updates > .upd-item").each(function(){$(this).fadeIn("fast")})},"html")}function rmCheckUpdates(){$.get(xoUrl+"/modules/rmcommon/ajax/updates.php",{XOOPS_TOKEN_REQUEST:$("#cu-token").val()},function(a){return""!=a.token&&$("#cu-token").val(a.token),a.total<=0?!1:void rmCallNotifier(a.total)},"json")}function rmCallNotifier(a){if(!(0>=a)){if("function"==typeof updatesNotifier&&updatesNotifier(a),$("#updater-info").length<=0)return!1;$("#updater-info").html($("#updater-info").html().replace("%s",a)),$("#updater-info").fadeIn("fast")}}function loadUpdateDetails(id){if(null==id||void 0==id)return!1;var updates=eval($("#json-container").html()),update=updates[id].data;if(""==update.url)return!1;if(null==update.url.match(/^http:\/\//))return!1;var url=update.url.replace(/\&amp;/,"&");$("#details").html(""),$("#files").html(""),$("#upd-info .tab-container").addClass("loading"),$("#upd-info").modal(),$.get("updates.php",{action:"update-details",url:url},function(a){1==a.error&&(alert(a.message),""!=a.token&&$("#cu-token").val(a.token),$("#upd-info-blocker").click()),""!=a.token&&$("#cu-token").val(a.token),$("#details").html(a.data.details),$("#files").html(a.data.files),$("#upd-info .tab-container").removeClass("loading")},"json")}function installUpdate(id){if(null==id||void 0==id)return!1;var updates=eval($("#json-container").html()),update=updates[id].data;if(null==update.url.match(/^http:\/\/|https:\/\//))return!1;var url=update.url.replace(/\&amp;/,"&");return $("#upd-warning .continue-update").attr("data-id",id),""!=update.warning&&void 0==warns[id]?void showWarning(update):1==update.login&&void 0==credentials[id]?($("#upd-login .ok-login").attr("data-id",id),void showLogin(update)):($("#upd-"+id+" .col-lg-4").hide(),$("#upd-"+id+" .col-lg-8").removeClass("col-lg-8").addClass("col-lg-12"),$("#upd-"+id).addClass("upd-item-process"),$("#upd-"+id+" .upd-progress").slideDown("fast"),void updateStepOne(update,id))}function downloadUpdate(id){if(null==id||void 0==id)return!1;var updates=eval($("#json-container").html()),update=updates[id].data;if(null==update.url.match(/^http:\/\//))return!1;var url=update.url.replace(/\&amp;/,"&");if(1==update.login&&void 0==credentials[id])return $("#upd-login .ok-login").attr("data-id",id),$("#upd-login").data("next","download"),void showLogin(update);var params={action:"later",url:url,credentials:void 0==credentials[id]?"":credentials[id],type:update.type,dir:update.dir};$.post("updates.php",params,function(a){return 1==a.error?(alert(a.message),void(""!=a.token&&$("#cu-token").val(a.token))):(""!=a.token&&$("#cu-token").val(a.token),$("#upd-"+id+" .button-later > i").removeClass("icon-spinner icon-spin").addClass("icon-time"),void(window.location.href="updates.php?action=getfile&file="+a.data.file))},"json")}function installLater(id){if(null==id||void 0==id)return!1;$("#upd-"+id+" .button-later > i").removeClass("icon-time").addClass("icon-spinner icon-spin");var updates=eval($("#json-container").html()),update=updates[id].data;if(null==update.url.match(/^http:\/\//))return!1;var url=update.url.replace(/\&amp;/,"&")+"&action=download";return 1==update.login&&void 0==credentials[id]?($("#upd-login .ok-login").attr("data-id",id),$("#upd-login").data("next","download"),void showLogin(update)):void downloadUpdate(id)}function showWarning(a){$("#upd-info-blocker").fadeIn("fast"),$("#upd-warning h4").html(a.title),$("#upd-warning p").html(a.warning),$("#upd-warning").fadeIn("fast")}function showLogin(update){$("#login-blocker").fadeIn("fast",function(){var updates=eval($("#json-container").html()),id=$("#upd-login .ok-login").data("id"),update=updates[id].data,a=document.createElement("a");a.href=update.url,$("#upd-login").fadeIn("fast"),$("#upd-login p").html($("#upd-login p").html().replace("%site%",'<a href="http://'+a.hostname+'" target="_blank">'+a.hostname+"</a>"))})}function updateStepOne(a,t){var e=a.url.replace(/\&amp;/,"&"),d={action:"first-step",url:e,credentials:void 0==credentials[t]?"":credentials[t],type:a.type,dir:a.dir,ftp:$("#ftp-form").serialize(),XOOPS_TOKEN_REQUEST:$("#cu-token").val()};incrementProgress("50%",t),$.post("updates.php",d,function(e){return 1==e.error?($("#upd-"+t+" .upd-progress .status").html(e.message),$("#upd-"+t+" .progress-bar").addClass("progress-bar-danger"),$("#upd-"+t+" .progress").removeClass("active"),""!=e.token&&$("#cu-token").val(e.token),!1):(""!=e.token&&$("#cu-token").val(e.token),$("#upd-"+t+" .upd-progress .status").html(e.message),void("module"==a.type||"plugin"==a.type?(incrementProgress("80%",t),local_update(t)):(incrementProgress("100%",t),$("#upd-"+t+" .progress-bar").addClass("progress-bar-success"),$("#upd-"+t+" .progress").removeClass("active"),$("#upd-"+t+" h4").addClass("update-done"))))},"json")}function local_update(id){var updates=eval($("#json-container").html()),update=updates[id].data,params={action:"local-update",type:update.type,module:update.dir,XOOPS_TOKEN_REQUEST:$("#cu-token").val()};$.post("updates.php",params,function(a){return 1==a.error?($("#upd-"+id+" .upd-progress .status").html(a.message),$("#upd-"+id+" .progress-bar").addClass("progress-bar-danger"),$("#upd-"+id+" .progress").removeClass("active"),""!=a.token&&$("#cu-token").val(a.token),!1):(""!=a.token&&$("#cu-token").val(a.token),cuHandler.modal.dialog({message:a.data.log,title:"Module update log",width:"large"}),$("#upd-"+id+" .upd-progress .status").html(a.message),incrementProgress("100%",id),$("#upd-"+id+" .progress-bar").addClass("progress-bar-success"),$("#upd-"+id+" .progress").removeClass("active"),void $("#upd-"+id+" h4").addClass("update-done"))},"json")}function runFiles(id,run){var files=eval(run),total=files.length-1,start=0;$("#files-blocker").fadeIn("fast",function(){$("#upd-run").fadeIn("fast",function(){$("#upd-run > iframe").attr("src",files[start]).load(function(){total>start?(start++,$(this).attr("src",files[start])):$("#upd-run").fadeOut("fast",function(){$("#files-blocker").fadeOut("fast",function(){$("#upd-"+id+" .upd-progress .status").html(langUpdated),incrementProgress("100%",id),$("#upd-"+id+" .progress").addClass("progress-bar-success").removeClass("active"),$("#upd-"+id+" h4").addClass("update-done")})})})})})}function incrementProgress(a,t){$("#upd-"+t+" .progress > .progress-bar").width(a)}var warns=new Array,credentials=new Array;$(document).ready(function(){$("#details").length>0&&$("#files").length>0&&loadUpdates(),$("#upds-ftp, #ftp-settings .btn-primary").click(function(){$("#ftp-settings").slideToggle("fast"),$("#upds-ftp").hasClass("active")?$("#upds-ftp").removeClass("active"):$("#upds-ftp").addClass("active")}),$("#refresh-updates").click(function(){$(this).children("span").addClass("fa-spin"),$(".rm-loading").fadeIn("fast"),$("#rmc-updates > div").each(function(){$(this).fadeOut("fast",function(){$(this).remove()})}),$.get(xoUrl+"/modules/rmcommon/ajax/updates.php",{XOOPS_TOKEN_REQUEST:$("#cu-token").val()},function(a){loadUpdates(),$("#refresh-updates > span").removeClass("fa-spin")},"json")}),$("#upd-warning .cancel-warning").click(function(){$("#upd-warning").fadeOut("fast",function(){$("#upd-info-blocker").fadeOut("fast")})}),$("#upd-warning .continue-update").click(function(){$("#upd-warning .cancel-warning").click();var a=$(this).attr("data-id");void 0==a||0>a||(warns[a]=1,installUpdate(a))}),$("#upd-login .cancel-login, #upd-login .close").click(function(){$("#upd-login").fadeOut("fast",function(){$("#login-blocker").fadeOut("fast"),$("#upd-login input").val("")})}),$("#upd-login .ok-login").click(function(){if(""==$("#uname").val())return void $("#uname").addClass("error").focus();if(""==$("#upass").val())return void $("#upass").addClass("error").focus();$("#upd-login .cancel-login").click();var a=$(this).attr("data-id");void 0==a||0>a||(credentials[a]=$("#uname").val()+":"+$("#upass").val(),"download"==$("#upd-login").data("next")?downloadUpdate(a):installUpdate(a))})});
